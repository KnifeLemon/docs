# Документація FlightPHP APM

Ласкаво просимо до FlightPHP APM — ваш особистий тренер продуктивності для додатків! Цей посібник є вашою картою для налаштування, використання та освоєння моніторингу продуктивності застосунків (APM) з FlightPHP. Чи ви полюєте на повільні запити, чи просто хочете насолоджуватися графіками затримок, ми все охопили. Давайте зробимо ваш додаток швидшим, користувачів щасливішими та сеанси налагодження легшими!

![FlightPHP APM](/images/apm.png)

## Чому APM важливий

Уявіть: ваш додаток — це зайнятий ресторан. Без способу відстежувати, скільки часу займають замовлення або де кухня гальмує, ви просто вгадуєте, чому клієнти йдуть незадоволеними. APM — це ваш помічник-кухар: він стежить за кожним кроком, від вхідних запитів до запитів бази даних, і позначає все, що сповільнює вас. Повільні сторінки втрачають користувачів (дослідження показують, що 53% відмовляються, якщо сайт завантажується більше 3 секунд!), а APM допомагає виявити ці проблеми *до* того, як вони завдадуть шкоди. Це проактивний спокій — менше моментів "чому це зламане?", більше перемог "дивись, як це працює гладко!".

## Встановлення

Розпочніть з Composer:

```bash
composer require flightphp/apm
```

Вам знадобиться:
- **PHP 7.4+**: Забезпечує сумісність з LTS-розподілами Linux, одночасно підтримуючи сучасний PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легковаговий фреймворк, який ми вдосконалюємо.

## Підтримувані бази даних

FlightPHP APM наразі підтримує такі бази даних для зберігання метрик:

- **SQLite3**: Проста, на основі файлів, і відмінна для локальної розробки або малих додатків. Опція за замовчуванням у більшості налаштувань.
- **MySQL/MariaDB**: Ідеальна для більших проєктів або виробничих середовищ, де потрібне надійне, масштабоване сховище.

Ви можете вибрати тип бази даних під час кроку налаштування (див. нижче). Переконайтеся, що ваше середовище PHP має встановлені необхідні розширення (наприклад, `pdo_sqlite` або `pdo_mysql`).

## Початок роботи

Ось ваш покроковий план до чудового APM:

### 1. Зареєструйте APM

Додайте це до вашого `index.php` або файлу `services.php`, щоб розпочати відстеження:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json');
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);

// Якщо ви додаєте з'єднання з базою даних
// Має бути PdoWrapper або PdoQueryCapture з розширень Tracy
$pdo = new PdoWrapper('mysql:host=localhost;dbname=example', 'user', 'pass', null, true); // <-- True потрібне, щоб увімкнути відстеження в APM.
$Apm->addPdoConnection($pdo);
```

**Що тут відбувається?**
- `LoggerFactory::create()` отримує вашу конфігурацію (про це скоро) і налаштовує логгер — SQLite за замовчуванням.
- `Apm` — зірка: він слухає події Flight (запити, маршрути, помилки тощо) і збирає метрики.
- `bindEventsToFlightInstance($app)` пов'язує все з вашим додатком Flight.

**Професійна порада: Зразок**
Якщо ваш додаток зайнятий, логування *кожного* запиту може перевантажити систему. Використовуйте коефіцієнт зразка (від 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логує 10% запитів
```

Це зберігає продуктивність швидкою, одночасно надаючи корисні дані.

### 2. Налаштуйте його

Запустіть це, щоб створити ваш `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Що це робить?**
- Запускає майстра, який запитує, звідки беруться сирі метрики (джерело) і куди йдуть оброблені дані (призначення).
- За замовчуванням — SQLite, наприклад, `sqlite:/tmp/apm_metrics.sqlite` для джерела, інше для призначення.
- Ви отримаєте конфігурацію, як-от:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

> Цей процес також запитає, чи ви хочете запустити міграції для цієї налаштування. Якщо ви налаштовуєте це вперше, відповідь — так.

**Чому два місця?**
Сірі метрики накопичуються швидко (думайте про нефільтровані журнали). Робочий процес обробляє їх у структуроване призначення для панелі керування. Це тримає все в порядку!

### 3. Обробка метрик за допомогою робочого процесу

Робочий процес перетворює сирі метрики на дані, готові для панелі. Запустіть його один раз:

```bash
php vendor/bin/runway apm:worker
```

**Що це робить?**
- Читає з вашого джерела (наприклад, `apm_metrics.sqlite`).
- Обробляє до 100 метрик (розмір пакета за замовчуванням) у ваше призначення.
- Зупиняється, коли завершено або якщо метрик не залишилося.

**Тримайте його в роботі**
Для живих додатків ви захочете безперервну обробку. Ось ваші опції:

- **Режим демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Працює вічно, обробляючи метрики, як вони приходять. Чудово для розробки або малих налаштувань.

- **Crontab**:
  Додайте це до вашого crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускається що хвилину — ідеально для виробництва.

- **Tmux/Screen**:
  Запустіть відокремлену сесію:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, потім D, щоб відокремитися; `tmux attach -t apm-worker`, щоб підключитися
  ```
  Тримає його в роботі навіть якщо ви вийдете.

- **Власні налаштування**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обробляє 50 метрик за раз.
  - `--max_messages 1000`: Зупиняється після 1000 метрик.
  - `--timeout 300`: Вийти після 5 хвилин.

**Чому турбуватися?**
Без робочого процесу ваша панель керування порожня. Це міст між сирими журналами та корисними висновками.

### 4. Запустіть панель керування

Перегляньте життєво важливі показники вашого додатку:

```bash
php vendor/bin/runway apm:dashboard
```

**Що це?**
- Запускає сервер PHP на `http://localhost:8001/apm/dashboard`.
- Показує журнали запитів, повільні маршрути, рівень помилок і більше.

**Налаштуйте це**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступне з будь-якої IP (зручно для віддаленого перегляду).
- `--port 8080`: Використовуйте інший порт, якщо 8001 зайнятий.
- `--php-path`: Вкажіть на PHP, якщо його немає в PATH.

Відкрийте URL у своєму браузері та досліджуйте!

#### Режим виробництва

Для виробництва вам може знадобитися спробувати кілька технік, щоб запустити панель керування, оскільки там, ймовірно, є брандмауери та інші заходи безпеки. Ось кілька опцій:

- **Використовуйте зворотний проксі**: Налаштуйте Nginx або Apache для переадресації запитів на панель.
- **SSH-тунель**: Якщо ви можете підключитися до сервера по SSH, використовуйте `ssh -L 8080:localhost:8001 youruser@yourserver`, щоб створити тунель панелі до вашого локального комп'ютера.
- **VPN**: Якщо ваш сервер за VPN, підключіться до нього та отримуйте доступ до панелі безпосередньо.
- **Налаштуйте брандмауер**: Відкрийте порт 8001 для вашого IP або мережі сервера (або будь-який порт, який ви встановили).
- **Налаштуйте Apache/Nginx**: Якщо у вас є веб-сервер перед додатком, ви можете налаштувати його на домен або піддомен. Якщо ви це зробите, встановіть корінь документів на `/path/to/your/project/vendor/flightphp/apm/dashboard`.

#### Хочете іншу панель?

Ви можете створити власну панель, якщо хочете! Подивіться у директорії `vendor/flightphp/apm/src/apm/presenter` за ідеями, як представити дані для вашої власної панелі!

## Функції панелі керування

Панель керування — це ваш штаб APM — ось що ви побачите:

- **Журнал запитів**: Кожний запит з часом, URL, кодом відповіді та загальним часом. Натисніть "Деталі", щоб побачити проміжне програмне забезпечення, запити та помилки.
- **Найповільніші запити**: Топ-5 запитів, які займають багато часу (наприклад, "/api/heavy" за 2.5с).
- **Найповільніші маршрути**: Топ-5 маршрутів за середнім часом — чудово для виявлення шаблонів.
- **Рівень помилок**: Відсоток запитів, які завершуються невдачею (наприклад, 2.3% 500s).
- **Перцентили затримок**: 95-й (p95) і 99-й (p99) часи відповідей — знайте ваші найгірші сценарії.
- **Діаграма кодів відповідей**: Візуалізуйте 200s, 404s, 500s з часом.
- **Довгі запити/проміжне програмне забезпечення**: Топ-5 повільних викликів бази даних і шарів проміжного програмного забезпечення.
- **Влучання/промах кешу**: Наскільки часто ваш кеш рятує ситуацію.

**Додатково**:
- Фільтруйте за "Останню годину", "Останній день" або "Останній тиждень".
- Перемикайте темний режим для нічних сеансів.

**Приклад**:
Запит до `/users` може показати:
- Загальний час: 150мс
- Проміжне програмне забезпечення: `AuthMiddleware->handle` (50мс)
- Запит: `SELECT * FROM users` (80мс)
- Кеш: Влучання на `user_list` (5мс)

## Додавання власних подій

Відстежуйте все — як виклик API або процес оплати:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Де це з'являється?**
У деталях запиту панелі під "Власні події" — розгортається з красивим форматуванням JSON.

**Приклад використання**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Тепер ви побачите, якщо цей API сповільнює ваш додаток!

## Моніторинг бази даних

Відстежуйте запити PDO ось так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite', null, null, null, true); // <-- True потрібне, щоб увімкнути відстеження в APM.
$Apm->addPdoConnection($pdo);
```

**Що ви отримуєте**:
- Текст запиту (наприклад, `SELECT * FROM users WHERE id = ?`)
- Час виконання (наприклад, 0.015с)
- Кількість рядків (наприклад, 42)

**Увага**:
- **Опційно**: Пропустіть це, якщо вам не потрібне відстеження БД.
- **Тільки PdoWrapper**: Основний PDO ще не підключений — слідкуйте за оновленнями!
- **Попередження про продуктивність**: Логування кожного запиту на сайті з важкою БД може сповільнити все. Використовуйте зразок (`$Apm = new Apm($ApmLogger, 0.1)`), щоб зменшити навантаження.

**Приклад виведення**:
- Запит: `SELECT name FROM products WHERE price > 100`
- Час: 0.023с
- Рядки: 15

## Опції робочого процесу

Налаштуйте робочий процес на свій смак:

- `--timeout 300`: Зупиняється після 5 хвилин — добре для тестування.
- `--max_messages 500`: Обмежує 500 метрик — тримає це скінченним.
- `--batch_size 200`: Обробляє 200 за раз — балансує швидкість і пам'ять.
- `--daemon`: Працює без зупину — ідеально для живого моніторингу.

**Приклад**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Працює годину, обробляючи 100 метрик за раз.

## ID запиту в додатку

Кожний запит має унікальний ID запиту для відстеження. Ви можете використовувати цей ID у своєму додатку, щоб корелювати журнали та метрики. Наприклад, ви можете додати ID запиту до сторінки помилок:

```php
Flight::map('error', function($message) {
	// Отримайте ID запиту з заголовка відповіді X-Flight-Request-Id
	$requestId = Flight::response()->getHeader('X-Flight-Request-Id');

	// Крім того, ви могли б отримати його з змінної Flight
	// Цей метод не працюватиме добре в swoole або інших асинхронних платформах.
	// $requestId = Flight::get('apm.request_id');
	
	echo "Error: $message (Request ID: $requestId)";
});
```

## Оновлення

Якщо ви оновлюєтеся до новішої версії APM, є шанс, що потрібно запустити міграції бази даних. Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:migrate
```
Це запустить будь-які необхідні міграції, щоб оновити схему бази даних до останньої версії.

**Примітка:** Якщо ваша база даних APM велика, ці міграції можуть зайняти деякий час. Ви можете запустити цю команду під час непікового часу.

## Очищення старих даних

Щоб тримати вашу базу даних в порядку, ви можете очистити старі дані. Це особливо корисно, якщо ви запускаєте зайнятий додаток і хочете тримати розмір бази керованим.
Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:purge
```
Це видалить всі дані старші за 30 днів з бази. Ви можете налаштувати кількість днів, передаючи інше значення опції `--days`:

```bash
php vendor/bin/runway apm:purge --days 7
```
Це видалить всі дані старші за 7 днів з бази.

## Усунення проблем

Зависли? Спробуйте ці:

- **Немає даних на панелі?**
  - Чи працює робочий процес? Перевірте `ps aux | grep apm:worker`.
  - Шляхи конфігурації збігаються? Перевірте, чи DSN у `.runway-config.json` вказують на реальні файли.
  - Запустіть `php vendor/bin/runway apm:worker` вручну, щоб обробити очікувані метрики.

- **Помилки робочого процесу?**
  - Погляньте на ваші файли SQLite (наприклад, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Перевірте журнали PHP на стек-треси.

- **Панель не запускається?**
  - Порт 8001 зайнятий? Використовуйте `--port 8080`.
  - PHP не знайдено? Використовуйте `--php-path /usr/bin/php`.
  - Брандмауер блокує? Відкрийте порт або використовуйте `--host localhost`.

- **Занадто повільно?**
  - Зменшіть коефіцієнт зразка: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Зменшіть розмір пакета: `--batch_size 20`.

- **Не відстежує винятки/помилки?**
  - Якщо у вас увімкнено [Tracy](https://tracy.nette.org/) для вашого проєкту, це перевизначить обробку помилок Flight. Вам потрібно вимкнути Tracy і переконатися, що `Flight::set('flight.handle_errors', true);` встановлено.

- **Не відстежує запити бази даних?**
  - Переконайтеся, що ви використовуєте `PdoWrapper` для з'єднань з базою даних.
  - Переконайтеся, що останній аргумент у конструкторі — `true`.