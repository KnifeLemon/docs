# FlightPHP APM Документація

Ласкаво просимо до FlightPHP APM — ваш особистий тренер продуктивності додатку! Цей посібник є вашою картою шляху для налаштування, використання та освоєння моніторингу продуктивності додатків (APM) з FlightPHP. Чи ви шукаєте повільні запити, чи просто хочете насолоджуватися графіками затримки, ми охопили все. Давайте зробимо ваш додаток швидшим, користувачів щасливішими та сеанси налагодження легшими!

![FlightPHP APM](/images/apm.png)

## Чому APM важливий

Уявіть: ваш додаток — це зайнятий ресторан. Без способу відстежувати, скільки часу займають замовлення або де кухня сповільнюється, ви вгадуєте, чому клієнти йдуть незадоволеними. APM — це ваш помічник-кухар: він спостерігає за кожним кроком, від вхідних запитів до запитів бази даних, і позначає все, що сповільнює вас. Повільні сторінки втрачають користувачів (дослідження показують, що 53% відмовляються, якщо сайт завантажується більше 3 секунд!), а APM допомагає виявити ці проблеми *до* того, як вони завдадуть шкоди. Це проактивний спокій — менше моментів "чому це зламане?", більше перемог "дивись, як це працює гладко!".

## Встановлення

Почніть з Composer:

```bash
composer require flightphp/apm
```

Вам знадобиться:
- **PHP 7.4+**: Забезпечує сумісність з LTS дистрибутивами Linux, одночасно підтримуючи сучасний PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легкий фреймворк, який ми покращуємо.

## Початок роботи

Ось ваш покроковий план до чудового APM:

### 1. Зареєструйте APM

Додайте це до вашого `index.php` або файлу `services.php`, щоб розпочати відстеження:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json'); // створює ваш конфіг (більше про це незабаром) і налаштовує логер — SQLite за замовчуванням
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app); // зв'язує все з вашим екземпляром Flight
```

**Що тут відбувається?**
- `LoggerFactory::create()` отримує ваш конфіг (більше про це незабаром) і налаштовує логер — SQLite за замовчуванням.
- `Apm` — зірка: він слухає події Flight (запити, маршрути, помилки тощо) і збирає метрики.
- `bindEventsToFlightInstance($app)` пов'язує все з вашим додатком Flight.

**Порада для професіоналів: Зразкування**
Якщо ваш додаток зайнятий, логування *кожного* запиту може перевантажити систему. Використовуйте коефіцієнт зразкування (від 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логує 10% запитів
```

Це зберігає продуктивність швидкою, одночасно надаючи надійні дані.

### 2. Налаштуйте його

Запустіть це, щоб створити ваш `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Що це робить?**
- Запускає майстра, який запитує, звідки походять сирі метрики (джерело) і куди йдуть оброблені дані (призначення).
- За замовчуванням — SQLite — наприклад, `sqlite:/tmp/apm_metrics.sqlite` для джерела, інше для призначення.
- Ви отримаєте конфіг, як-от:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

> Цей процес також запитає, чи ви хочете запустити міграції для цієї налаштування. Якщо ви налаштовуєте це вперше, відповідь — так.

**Чому два місця?**
Сирі метрики накопичуються швидко (думайте про нефільтровані логи). Робітник обробляє їх у структуроване призначення для панелі керування. Це тримає все в порядку!

### 3. Обробка метрик за допомогою Робітника

Робітник перетворює сирі метрики на дані, готові для панелі керування. Запустіть його раз:

```bash
php vendor/bin/runway apm:worker
```

**Що воно робить?**
- Читає з вашого джерела (наприклад, `apm_metrics.sqlite`).
- Обробляє до 100 метрик (розмір пакета за замовчуванням) у ваше призначення.
- Зупиняється, коли закінчено або якщо метрик не залишилося.

**Тримайте його в роботі**
Для живих додатків ви захочете безперервну обробку. Ось ваші варіанти:

- **Режим Демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Працює вічно, обробляючи метрики, як вони приходять. Чудово для розробки або малих налаштувань.

- **Crontab**:
  Додайте це до вашого crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускається кожну хвилину — ідеально для виробництва.

- **Tmux/Screen**:
  Запустіть сеанс, який можна від'єднати:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, потім D, щоб від'єднати; `tmux attach -t apm-worker`, щоб під'єднатися
  ```
  Тримає це в роботі навіть якщо ви вийдете з системи.

- **Власні налаштування**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обробляє 50 метрик за раз.
  - `--max_messages 1000`: Зупиняється після 1000 метрик.
  - `--timeout 300`: Вийти після 5 хвилин.

**Навіщо це робити?**
Без робітника ваша панель керування порожня. Він — міст між сирими логами та корисними інсайтами.

### 4. Запустіть Панель керування

Перегляньте життєво важливі показники вашого додатку:

```bash
php vendor/bin/runway apm:dashboard
```

**Що це?**
- Запускає сервер PHP на `http://localhost:8001/apm/dashboard`.
- Показує логи запитів, повільні маршрути, рівень помилок і більше.

**Налаштуйте його**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступний з будь-якого IP (корисно для віддаленого перегляду).
- `--port 8080`: Використовуйте інший порт, якщо 8001 зайнятий.
- `--php-path`: Вкажіть шлях до PHP, якщо його немає в PATH.

Відкрийте URL у своєму браузері та досліджуйте!

#### Режим Виробництва

Для виробництва вам може знадобитися спробувати кілька технік, щоб запустити панель керування, оскільки там, ймовірно, є брандмауери та інші заходи безпеки. Ось кілька варіантів:

- **Використовуйте Реверс-Проксі**: Налаштуйте Nginx або Apache для перенаправлення запитів на панель керування.
- **SSH Тунель**: Якщо ви можете SSH на сервер, використовуйте `ssh -L 8080:localhost:8001 youruser@yourserver`, щоб створити тунель панелі керування до вашого локального комп'ютера.
- **VPN**: Якщо ваш сервер за VPN, під'єднайтеся до нього та отримайте доступ до панелі керування безпосередньо.
- **Налаштуйте Брандмауер**: Відкрийте порт 8001 для вашого IP або мережі сервера (або будь-який порт, який ви встановили).
- **Налаштуйте Apache/Nginx**: Якщо у вас є веб-сервер перед додатком, ви можете налаштувати його на домен або піддомен. Якщо ви це зробите, ви встановите корінь документів на `/path/to/your/project/vendor/flightphp/apm/dashboard`.

#### Хочете іншу панель керування?

Ви можете створити свою власну панель керування, якщо хочете! Подивіться на каталог vendor/flightphp/apm/src/apm/presenter для ідей, як представити дані для вашої власної панелі керування!

## Можливості Панелі керування

Панель керування — це ваш штаб APM — ось що ви побачите:

- **Лог Запитів**: Кожний запит з часом, URL, кодом відповіді та загальним часом. Натисніть "Деталі" для проміжного ПЗ, запитів і помилок.
- **Найповільніші Запити**: Топ-5 запитів, які займають багато часу (наприклад, “/api/heavy” на 2.5s).
- **Найповільніші Маршрути**: Топ-5 маршрутів за середнім часом — чудово для виявлення шаблонів.
- **Рівень Помилок**: Відсоток запитів, які не вдаються (наприклад, 2.3% 500s).
- **Перцентилі Затримки**: 95-й (p95) і 99-й (p99) часи відповіді — знайте ваші найгірші сценарії.
- **Діаграма Кодів Відповідей**: Візуалізуйте 200s, 404s, 500s з часом.
- **Довгі Запити/Проміжне ПЗ**: Топ-5 повільних викликів бази даних і шарів проміжного ПЗ.
- **Влучання/Промах Кешу**: Наскільки часто кеш рятує ситуацію.

**Додаткове**:
- Фільтруйте за "Останньою Годиною", "Останнім Днем" або "Останнім Тижнем".
- Перемикайте темний режим для нічних сеансів.

**Приклад**:
Запит до `/users` може показати:
- Загальний Час: 150ms
- Проміжне ПЗ: `AuthMiddleware->handle` (50ms)
- Запит: `SELECT * FROM users` (80ms)
- Кеш: Влучання на `user_list` (5ms)

## Додавання Власних Подій

Відстежуйте все — як виклик API або процес оплати:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
])); // де це з'являється? У деталях запиту панелі керування під "Власні Події" — розгортається з красивим форматуванням JSON
```

**Приклад Використання**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
])); // Тепер ви побачите, чи цей API сповільнює ваш додаток!
```

## Моніторинг Бази Даних

Відстежуйте запити PDO ось так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite');
$Apm->addPdoConnection($pdo); // Що ви отримуєте: Текст запиту (наприклад, `SELECT * FROM users WHERE id = ?`), Час виконання (наприклад, 0.015s), Кількість рядків (наприклад, 42)
```

**Пам'ятайте**:
- **Необов'язково**: Пропустіть це, якщо вам не потрібен відстеження БД.
- **Тільки PdoWrapper**: Основний PDO ще не підключений — слідкуйте за оновленнями!
- **Попередження про Продуктивність**: Логування кожного запиту на сайті з важкою БД може сповільнити все. Використовуйте зразкування (`$Apm = new Apm($ApmLogger, 0.1)`), щоб зменшити навантаження.

**Приклад Виводу**:
- Запит: `SELECT name FROM products WHERE price > 100`
- Час: 0.023s
- Рядки: 15

## Опції Робітника

Налаштуйте робітника на свій смак:

- `--timeout 300`: Зупиняється після 5 хвилин — добре для тестування.
- `--max_messages 500`: Обмежує 500 метрик — тримає це скінченним.
- `--batch_size 200`: Обробляє 200 за раз — балансує швидкість і пам'ять.
- `--daemon`: Працює безперервно — ідеально для живого моніторингу.

**Приклад**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Працює годину, обробляючи 100 метрик за раз.

## ID Запиту в Додатку

Кожний запит має унікальний ID запиту для відстеження. Ви можете використовувати цей ID у своєму додатку, щоб корелювати логи та метрики. Наприклад, ви можете додати ID запиту до сторінки помилок:

```php
Flight::map('error', function($message) {
	// Отримайте ID запиту з заголовка відповіді X-Flight-Request-Id
	$requestId = Flight::response()->getHeader('X-Flight-Request-Id');

	// Крім того, ви могли б отримати його з змінної Flight
	// Цей метод не працюватиме добре в swoole або інших асинхронних платформах.
	// $requestId = Flight::get('apm.request_id');
	
	echo "Error: $message (Request ID: $requestId)";
});
```

## Оновлення

Якщо ви оновлюєтеся до новішої версії APM, є ймовірність, що потрібно запустити міграції бази даних. Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:migrate
```
Це запустить будь-які необхідні міграції, щоб оновити схему бази даних до останньої версії.

**Примітка:** Якщо ваша база даних APM велика, ці міграції можуть зайняти деякий час. Ви можете запустити цю команду під час годин з низким навантаженням.

## Видалення Старих Даних

Щоб тримати вашу базу даних в порядку, ви можете видалити старі дані. Це особливо корисно, якщо ви запускаєте зайнятий додаток і хочете тримати розмір бази даних керованим.
Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:purge
```
Це видалить всі дані старші за 30 днів з бази даних. Ви можете налаштувати кількість днів, передаючи інше значення до опції `--days`:

```bash
php vendor/bin/runway apm:purge --days 7
```
Це видалить всі дані старші за 7 днів з бази даних.

## Усунення Проблем

Зависли? Спробуйте ці поради:

- **Немає Даних на Панелі Керування?**
  - Чи працює робітник? Перевірте `ps aux | grep apm:worker`.
  - Шляхи конфігу збігаються? Перевірте, чи DSN у `.runway-config.json` вказують на реальні файли.
  - Запустіть `php vendor/bin/runway apm:worker` вручну, щоб обробити очікувані метрики.

- **Помилки Робітника?**
  - Подивіться на ваші файли SQLite (наприклад, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Перевірте логи PHP на стек-треси.

- **Панель Керування Не Запускається?**
  - Порт 8001 зайнятий? Використовуйте `--port 8080`.
  - PHP не знайдено? Використовуйте `--php-path /usr/bin/php`.
  - Брандмауер блокує? Відкрийте порт або використовуйте `--host localhost`.

- **Занадто Повільно?**
  - Зменшіть коефіцієнт зразкування: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Зменшіть розмір пакета: `--batch_size 20`.