# Документация FlightPHP APM

Добро пожаловать в FlightPHP APM — ваш личный тренер производительности приложения! Это руководство — ваша карта пути для настройки, использования и освоения мониторинга производительности приложения (APM) с FlightPHP. Будь то охота за медленными запросами или просто желание погрузиться в графики задержек, мы всё охватили. Давайте сделаем ваше приложение быстрее, пользователей счастливее и сессии отладки проще!

![FlightPHP APM](/images/apm.png)

## Почему APM важно

Представьте: ваше приложение — это оживлённый ресторан. Без отслеживания времени заказов или выявления проблем в кухне вы просто угадываете, почему клиенты уходят недовольными. APM — ваш помощник-шеф-повар — он наблюдает за каждым шагом, от входящих запросов до запросов к базе данных, и отмечает всё, что замедляет процесс. Медленные страницы отпугивают пользователей (исследования показывают, что 53% уходят, если сайт загружается более 3 секунд!), и APM помогает выявить эти проблемы *до* того, как они ударят. Это proactive спокойствие — меньше моментов "почему это сломалось?", больше побед "смотрите, как гладко это работает!".

## Установка

Начните с Composer:

```bash
composer require flightphp/apm
```

Вам понадобится:
- **PHP 7.4+**: Обеспечивает совместимость с LTS-дистрибутивами Linux и поддержку современного PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легковесный фреймворк, который мы улучшаем.

## Поддерживаемые базы данных

FlightPHP APM в настоящее время поддерживает следующие базы данных для хранения метрик:

- **SQLite3**: Простая, на основе файла, идеально подходит для локальной разработки или небольших приложений. Вариант по умолчанию в большинстве настроек.
- **MySQL/MariaDB**: Идеально для крупных проектов или production-сред, где нужна надёжная, масштабируемая хранение.

Вы можете выбрать тип базы данных на этапе конфигурации (см. ниже). Убедитесь, что в вашей среде PHP установлены необходимые расширения (например, `pdo_sqlite` или `pdo_mysql`).

## Начало работы

Вот ваш пошаговый план к крутизне APM:

### 1. Зарегистрируйте APM

Добавьте это в ваш `index.php` или файл `services.php`, чтобы начать отслеживание:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json); // Создаёт логгер на основе конфигурации (подробнее скоро)
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);

// Если вы добавляете соединение с базой данных
// Должно быть PdoWrapper или PdoQueryCapture из Tracy Extensions
$pdo = new PdoWrapper('mysql:host=localhost;dbname=example', 'user', 'pass', null, true); // <-- True обязательно, чтобы включить отслеживание в APM.
$Apm->addPdoConnection($pdo);
```

**Что здесь происходит?**
- `LoggerFactory::create()` берёт вашу конфигурацию (подробнее скоро) и настраивает логгер — SQLite по умолчанию.
- `Apm` — звезда — он слушает события Flight (запросы, маршруты, ошибки и т.д.) и собирает метрики.
- `bindEventsToFlightInstance($app)` связывает всё с вашим приложением Flight.

**Профессиональный совет: Сэмплирование**
Если ваше приложение загружено, логирование *каждого* запроса может перегрузить систему. Используйте коэффициент сэмплирования (от 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логирует 10% запросов
```

Это сохраняет производительность, при этом давая надёжные данные.

### 2. Настройте это

Запустите это, чтобы создать `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Что это делает?**
- Запускает мастер, спрашивающий, откуда берутся сырые метрики (источник) и куда идут обработанные данные (назначение).
- По умолчанию — SQLite, например, `sqlite:/tmp/apm_metrics.sqlite` для источника, другой для назначения.
- В результате вы получите конфигурацию вроде:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

> Этот процесс также спросит, хотите ли вы запустить миграции для этой настройки. Если вы настраиваете это в первый раз, ответ — да.

**Почему два места?**
Сырые метрики накапливаются быстро (думайте о нефильтрованных логах). Рабочий процесс обрабатывает их в структурированное назначение для дашборда. Это поддерживает порядок!

### 3. Обработайте метрики с помощью воркера

Воркер превращает сырые метрики в данные, готовые для дашборда. Запустите его один раз:

```bash
php vendor/bin/runway apm:worker
```

**Что он делает?**
- Читает из вашего источника (например, `apm_metrics.sqlite`).
- Обрабатывает до 100 метрик (размер пакета по умолчанию) в назначение.
- Останавливается, когда закончено или если метрик не осталось.

**Сделайте его непрерывным**
Для живых приложений вам нужна постоянная обработка. Вот варианты:

- **Режим демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Работает вечно, обрабатывая метрики по мере поступления. Отлично для разработки или небольших настроек.

- **Crontab**:
  Добавьте это в ваш crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускается каждую минуту — идеально для production.

- **Tmux/Screen**:
  Запустите сеанс, который можно отсоединить:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, затем D для отсоединения; `tmux attach -t apm-worker` для подключения
  ```
  Поддерживает работу даже после выхода.

- **Пользовательские настройки**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обрабатывает 50 метрик за раз.
  - `--max_messages 1000`: Останавливается после 1000 метрик.
  - `--timeout 300`: Выходит через 5 минут.

**Почему это важно?**
Без воркера дашборд будет пустым. Это мост между сырыми логами и полезными инсайтами.

### 4. Запустите дашборд

Посмотрите на виталы вашего приложения:

```bash
php vendor/bin/runway apm:dashboard
```

**Что это?**
- Запускает PHP-сервер по адресу `http://localhost:8001/apm/dashboard`.
- Показывает логи запросов, медленные маршруты, процент ошибок и многое другое.

**Настройте это**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступно с любого IP (полезно для удалённого просмотра).
- `--port 8080`: Используйте другой порт, если 8001 занят.
- `--php-path`: Укажите путь к PHP, если он не в PATH.

Откройте URL в браузере и исследуйте!

#### Режим production

Для production может потребоваться несколько техник, чтобы запустить дашборд, учитывая файрволы и другие меры безопасности. Вот варианты:

- **Используйте обратный прокси**: Настройте Nginx или Apache для переадресации запросов на дашборд.
- **SSH Tunnel**: Если вы можете SSH на сервер, используйте `ssh -L 8080:localhost:8001 youruser@yourserver`, чтобы туннелировать дашборд на вашу локальную машину.
- **VPN**: Если сервер за VPN, подключитесь и получите доступ к дашборду напрямую.
- **Настройте файрвол**: Откройте порт 8001 для вашего IP или сети сервера (или любого другого порта).
- **Настройте Apache/Nginx**: Если у вас есть веб-сервер перед приложением, настройте его на домен или поддомен. В этом случае установите корень документов на `/path/to/your/project/vendor/flightphp/apm/dashboard`.

#### Хотите другой дашборд?

Вы можете создать свой собственный дашборд, если хотите! Посмотрите в каталог vendor/flightphp/apm/src/apm/presenter за идеями, как представить данные для вашего дашборда!

## Функции дашборда

Дашборд — ваш штаб APM — вот что вы увидите:

- **Лог запросов**: Каждый запрос с временной меткой, URL, кодом ответа и общим временем. Нажмите "Детали", чтобы увидеть посредников, запросы и ошибки.
- **Самые медленные запросы**: Топ-5 запросов, которые занимают много времени (например, “/api/heavy” за 2.5s).
- **Самые медленные маршруты**: Топ-5 маршрутов по среднему времени — отлично для выявления шаблонов.
- **Процент ошибок**: Процент неудачных запросов (например, 2.3% 500s).
- **Перцентили задержек**: 95-й (p95) и 99-й (p99) времена ответа — знайте ваши худшие сценарии.
- **Диаграмма кодов ответов**: Визуализируйте 200s, 404s, 500s со временем.
- **Долгие запросы/Посредники**: Топ-5 медленных вызовов базы данных и слоёв посредников.
- **Попадания/Промахи кэша**: Насколько часто кэш спасает ситуацию.

**Дополнительно**:
- Фильтруйте по "Последний час", "Последний день" или "Последняя неделя".
- Переключайте тёмный режим для поздних ночных сессий.

**Пример**:
Запрос к `/users` может показать:
- Общее время: 150ms
- Посредник: `AuthMiddleware->handle` (50ms)
- Запрос: `SELECT * FROM users` (80ms)
- Кэш: Попадание на `user_list` (5ms)

## Добавление пользовательских событий

Отслеживайте всё — например, вызов API или процесс оплаты:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Где это отобразится?**
В деталях запроса дашборда под "Пользовательскими событиями" — расширяемо с красивым форматом JSON.

**Применение**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Теперь вы увидите, если этот API замедляет ваше приложение!

## Мониторинг базы данных

Отслеживайте запросы PDO вот так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite', null, null, null, true); // <-- True обязательно, чтобы включить отслеживание в APM.
$Apm->addPdoConnection($pdo);
```

**Что вы получите**:
- Текст запроса (например, `SELECT * FROM users WHERE id = ?`)
- Время выполнения (например, 0.015s)
- Количество строк (например, 42)

**Внимание**:
- **Опционально**: Пропустите это, если вам не нужен отслеживание БД.
- **Только PdoWrapper**: Обычный PDO пока не подключён — следите за обновлениями!
- **Предупреждение о производительности**: Логирование каждого запроса на сайте с большой нагрузкой на БД может замедлить всё. Используйте сэмплирование (`$Apm = new Apm($ApmLogger, 0.1)`), чтобы облегчить нагрузку.

**Пример вывода**:
- Запрос: `SELECT name FROM products WHERE price > 100`
- Время: 0.023s
- Строки: 15

## Опции воркера

Настройте воркер по вашему вкусу:

- `--timeout 300`: Останавливается через 5 минут — хорошо для тестов.
- `--max_messages 500`: Ограничивается 500 метриками — делает это конечным.
- `--batch_size 200`: Обрабатывает 200 за раз — балансирует скорость и память.
- `--daemon`: Работает nonstop — идеально для живого мониторинга.

**Пример**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Работает час, обрабатывая 100 метрик за раз.

## ID запроса в приложении

Каждый запрос имеет уникальный ID для отслеживания. Вы можете использовать этот ID в приложении, чтобы коррелировать логи и метрики. Например, добавьте ID запроса на страницу ошибок:

```php
Flight::map('error', function($message) {
	// Получите ID запроса из заголовка ответа X-Flight-Request-Id
	$requestId = Flight::response()->getHeader('X-Flight-Request-Id');

	// Кроме того, вы можете получить его из переменной Flight
	// Этот метод может не работать хорошо в swoole или других асинхронных платформах.
	// $requestId = Flight::get('apm.request_id');
	
	echo "Error: $message (Request ID: $requestId)";
});
```

## Обновление

Если вы обновляетесь до новой версии APM, возможно, потребуется запустить миграции базы данных. Сделайте это командой:

```bash
php vendor/bin/runway apm:migrate
```
Это запустит любые необходимые миграции для обновления схемы базы данных до последней версии.

**Примечание:** Если ваша база данных APM велика, эти миграции могут занять время. Запустите команду в часы низкой нагрузки.

## Очистка старых данных

Чтобы сохранить базу данных в порядке, очистите старые данные. Это особенно полезно для загруженных приложений, чтобы сохранить размер базы управляемым.
Запустите команду:

```bash
php vendor/bin/runway apm:purge
```
Это удалит все данные старше 30 дней. Вы можете изменить количество дней, передавая другой значение в опции `--days`:

```bash
php vendor/bin/runway apm:purge --days 7
```
Это удалит все данные старше 7 дней.

## Устранение неисправностей

Зависли? Попробуйте:

- **Нет данных в дашборде?**
  - Работает ли воркер? Проверьте `ps aux | grep apm:worker`.
  - Совпадают ли пути в конфигурации? Проверьте DSN в `.runway-config.json`, чтобы они указывали на реальные файлы.
  - Запустите `php vendor/bin/runway apm:worker` вручную, чтобы обработать ожидающие метрики.

- **Ошибки воркера?**
  - Посмотрите в файлы SQLite (например, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Проверьте логи PHP на стек-трейсы.

- **Дашборд не запускается?**
  - Занят ли порт 8001? Используйте `--port 8080`.
  - PHP не найден? Используйте `--php-path /usr/bin/php`.
  - Файрвол блокирует? Откройте порт или используйте `--host localhost`.

- **Слишком медленно?**
  - Уменьшите коэффициент сэмплирования: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Уменьшите размер пакета: `--batch_size 20`.

- **Не отслеживаются исключения/Ошибки?**
  - Если у вас включён [Tracy](https://tracy.nette.org/) в проекте, он переопределяет обработку ошибок Flight. Отключите Tracy и убедитесь, что `Flight::set('flight.handle_errors', true);` установлено.

- **Не отслеживаются запросы к базе данных?**
  - Убедитесь, что вы используете `PdoWrapper` для соединений с базой.
  - Убедитесь, что последний аргумент в конструкторе — `true`.