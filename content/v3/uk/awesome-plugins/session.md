# FlightPHP Сесія - Легкий обробник сесій на основі файлів

Це легкий плагін для обробки сесій на основі файлів для [Flight PHP Framework](https://docs.flightphp.com/). Він надає просте, але потужне рішення для управління сесіями, з такими функціями, як неблокуючі читання сесій, необов'язкова шифрування, функціональність автозбереження та режим тестування для розробки. Дані сесії зберігаються у файлах, що робить його ідеальним для додатків, які не потребують бази даних.

Якщо ви хочете використовувати базу даних, ознайомтеся з плагіном [ghostff/session](/awesome-plugins/ghost-session), який має багато з цих самих функцій, але з бекендом бази даних.

Відвідайте [репозиторій Github](https://github.com/flightphp/session) для повного вихідного коду та деталей.

## Встановлення

Встановіть плагін через Composer:

```bash
composer require flightphp/session
```

## Основне використання

Ось простий приклад того, як використовувати плагін `flightphp/session` у вашому додатку Flight:

```php
require 'vendor/autoload.php';

use flight\Session;

$app = Flight::app();

// Зареєструйте сервіс сесій
$app->register('session', Session::class);

// Приклад маршруту з використанням сесії
Flight::route('/login', function() {
    $session = Flight::session();
    $session->set('user_id', 123);
    $session->set('username', 'johndoe');
    $session->set('is_admin', false);

    echo $session->get('username'); // Виводить: johndoe
    echo $session->get('preferences', 'default_theme'); // Виводить: default_theme

    if ($session->get('user_id')) {
        Flight::json(['message' => 'Користувач увійшов в систему!', 'user_id' => $session->get('user_id')]);
    }
});

Flight::route('/logout', function() {
    $session = Flight::session();
    $session->clear(); // Очистити всі дані сесії
    Flight::json(['message' => 'Вихід виконано успішно']);
});

Flight::start();
```

### Ключові моменти
- **Неблокуючий**: Використовує `read_and_close` для початку сесії за замовчуванням, запобігаючи проблемам з блокуванням сесій.
- **Автозбереження**: Увімкнено за замовчуванням, тому зміни зберігаються автоматично при завершенні роботи, якщо не вимкнено.
- **Зберігання файлів**: Сесії зберігаються в системній папці для тимчасових файлів за замовчуванням у `/flight_sessions`.

## Налаштування

Ви можете налаштувати обробник сесій, передаючи масив параметрів при реєстрації:

```php
$app->register('session', Session::class, [
    'save_path' => '/custom/path/to/sessions',         // Директорія для файлів сесій
    'encryption_key' => 'a-secure-32-byte-key-here',   // Увімкнути шифрування (рекомендовано 32 байти для AES-256-CBC)
    'auto_commit' => false,                            // Вимкнути автозбереження для ручного контролю
    'start_session' => true,                           // Автоматично розпочати сесію (за замовчуванням: так)
    'test_mode' => false                               // Увімкнути тестовий режим для розробки
]);
```

### Параметри конфігурації
| Параметр            | Опис                                               | Значення за замовчуванням                     |
|---------------------|---------------------------------------------------|------------------------------------------------|
| `save_path`         | Директорія, де зберігаються файли сесій          | `sys_get_temp_dir() . '/flight_sessions'` |
| `encryption_key`    | Ключ для шифрування AES-256-CBC (необов'язковий) | `null` (без шифрування)                       |
| `auto_commit`       | Авто-збереження даних сесії при завершенні роботи | `true`                                         |
| `start_session`     | Автоматично розпочати сесію                      | `true`                                         |
| `test_mode`         | Запустити в тестовому режимі, не впливаючи на PHP сесії | `false`                                   |
| `test_session_id`   | Користувацький ID сесії для тестового режиму (необов'язковий) | Генерується випадково, якщо не задано |

## Розширене використання

### Ручне збереження
Якщо ви вимкнули автозбереження, вам потрібно вручну зафіксувати зміни:

```php
$app->register('session', Session::class, ['auto_commit' => false]);

Flight::route('/update', function() {
    $session = Flight::session();
    $session->set('key', 'value');
    $session->commit(); // Явно зберегти зміни
});
```

### Безпека сесії з шифруванням
Увімкніть шифрування для чутливих даних:

```php
$app->register('session', Session::class, [
    'encryption_key' => 'your-32-byte-secret-key-here'
]);

Flight::route('/secure', function() {
    $session = Flight::session();
    $session->set('credit_card', '4111-1111-1111-1111'); // Автоматично зашифровано
    echo $session->get('credit_card'); // Дешифровано під час отримання
});
```

### Регенація сесії
Регеніруйте ID сесії для безпеки (наприклад, після входу в систему):

```php
Flight::route('/post-login', function() {
    $session = Flight::session();
    $session->regenerate(); // Новий ID, зберегти дані
    // АБО
    $session->regenerate(true); // Новий ID, вилучити старі дані
});
```

### Приклад Middleware
Захистіть маршрути за допомогою аутентифікації на основі сесій:

```php
Flight::route('/admin', function() {
    Flight::json(['message' => 'Ласкаво просимо до панелі адміністрування']);
})->addMiddleware(function() {
    $session = Flight::session();
    if (!$session->get('is_admin')) {
        Flight::halt(403, 'Доступ заборонено');
    }
});
```

Це лише простий приклад того, як використовувати це в middleware. Для більш детального прикладу див. документацію [middleware](/learn/middleware).

## Методи

Клас `Session` надає ці методи:

- `set(string $key, $value)`: Зберігає значення в сесії.
- `get(string $key, $default = null)`: Отримує значення з необов'язковим значенням за замовчуванням, якщо ключ не існує.
- `delete(string $key)`: Видаляє певний ключ із сесії.
- `clear()`: Видаляє всі дані сесії.
- `commit()`: Зберігає поточні дані сесії у файловій системі.
- `id()`: Повертає поточний ID сесії.
- `regenerate(bool $deleteOld = false)`: Регенірує ID сесії, при потребі видаляючи старі дані.

Усі методи, крім `get()` і `id()`, повертають екземпляр `Session` для ланцюгового виклику.

## Чому варто використовувати цей плагін?

- **Легкий**: Без зовнішніх залежностей — лише файли.
- **Неблокуючий**: Уникає блокування сесій з `read_and_close` за замовчуванням.
- **Безпечно**: Підтримує шифрування AES-256-CBC для чутливих даних.
- **Гнучкий**: Опції автозбереження, тестовий режим і ручний контроль.
- **Flight-Native**: Побудований спеціально для фреймворку Flight.

## Технічні деталі

- **Формат зберігання**: Файли сесій мають префікс `sess_` і зберігаються в сконфігурованій `save_path`. Зашифровані дані використовують префікс `E`, текстові — `P`.
- **Шифрування**: Використовує AES-256-CBC з випадковим IV для кожного запису сесії, коли надано `encryption_key`.
- **Сміттєзвалище**: Реалізує `SessionHandlerInterface::gc()` PHP для очищення термінових сесій.

## Консультування

Внесення змін віталося! Форкніть [репозиторій](https://github.com/flightphp/session), внесіть свої зміни та надішліть запит на злиття. Повідомляйте про помилки або пропонуйте функції через трекер проблем Github.

## Ліцензія

Цей плагін ліцензований під ліцензією MIT. Дивіться [репозиторій Github](https://github.com/flightphp/session) для деталей.