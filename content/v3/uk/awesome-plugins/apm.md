# Документація FlightPHP APM

Ласкаво просимо до FlightPHP APM — вашого особистого тренера продуктивності для додатку! Цей посібник — ваша дорожня карта для налаштування, використання та освоєння Application Performance Monitoring (APM) з FlightPHP. Чи то ви полюєте на повільні запити, чи просто хочете зануритися в графіки затримок, ми вас охоплюємо. Давайте зробимо ваш додаток швидшим, ваших користувачів щасливішими, а сесії налагодження — легкими!

Перегляньте [демо](https://flightphp-docs-apm.sky-9.com/apm/dashboard) панелі керування для сайту Flight Docs.

![FlightPHP APM](/images/apm.png)

## Чому APM важливий

Уявіть: ваш додаток — це зайнятий ресторан. Без способу відстежувати, скільки часу займають замовлення чи де кухня гальмує, ви вгадуєте, чому клієнти йдуть незадоволеними. APM — ваш помічник на кухні: він стежить за кожним кроком, від вхідних запитів до запитів до бази даних, і позначає все, що вас сповільнює. Повільні сторінки втрачають користувачів (дослідження кажуть, що 53% відскакують, якщо сайт завантажується понад 3 секунди!), а APM допомагає вам ловити ці проблеми *до* того, як вони вжаліть. Це проактивний спокій — менше моментів «чому це зламано?», більше перемог «дивись, як гладко це працює!».

## Встановлення

Почніть з Composer:

```bash
composer require flightphp/apm
```

Вам знадобиться:
- **PHP 7.4+**: Забезпечує сумісність з LTS дистрибутивами Linux, підтримуючи сучасний PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легкий фреймворк, який ми посилюємо.

## Підтримувані бази даних

FlightPHP APM зараз підтримує такі бази даних для зберігання метрик:

- **SQLite3**: Простий, на основі файлів, чудовий для локальної розробки чи малих додатків. Варіант за замовчуванням у більшості налаштувань.
- **MySQL/MariaDB**: Ідеальний для більших проєктів чи продакшн-середовищ, де потрібне надійне, масштабоване сховище.

Ви можете обрати тип бази даних під час кроку конфігурації (див. нижче). Переконайтеся, що ваше середовище PHP має встановлені необхідні розширення (наприклад, `pdo_sqlite` чи `pdo_mysql`).

## Початок роботи

Ось ваш покроковий шлях до крутості APM:

### 1. Зареєструйте APM

Додайте це до вашого `index.php` чи файлу `services.php`, щоб почати відстеження:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json');
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);

// Якщо ви додаєте з'єднання з базою даних
// Має бути PdoWrapper або PdoQueryCapture з Tracy Extensions
$pdo = new PdoWrapper('mysql:host=localhost;dbname=example', 'user', 'pass', null, true); // <-- True обов'язково для увімкнення відстеження в APM.
$Apm->addPdoConnection($pdo);
```

**Що тут відбувається?**
- `LoggerFactory::create()` бере вашу конфігурацію (більше про це незабаром) і налаштовує логер — SQLite за замовчуванням.
- `Apm` — зірка: він слухає події Flight (запити, маршрути, помилки тощо) і збирає метрики.
- `bindEventsToFlightInstance($app)` пов'язує все з вашим додатком Flight.

**Про порада: Збірка зразків**
Якщо ваш додаток зайнятий, логування *кожного* запиту може перевантажити. Використовуйте рівень вибірки (від 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логує 10% запитів
```

Це тримає продуктивність жвавою, але все одно дає солідні дані.

### 2. Налаштуйте це

Запустіть це, щоб створити `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Що це робить?**
- Запускає майстер, який запитує, звідки беруться сирі метрики (джерело) і куди йде оброблені дані (призначення).
- За замовчуванням SQLite — наприклад, `sqlite:/tmp/apm_metrics.sqlite` для джерела, інше для призначення.
- Ви отримаєте конфігурацію на кшталт:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

> Цей процес також запитає, чи хочете ви запустити міграції для цього налаштування. Якщо це перше налаштування, відповідь — так.

**Чому два місця?**
Сирі метрики накопичуються швидко (уявіть нефільтровані логи). Робочий процес обробляє їх у структуроване призначення для панелі керування. Тримає все охайним!

### 3. Обробіть метрики з Worker

Робочий процес перетворює сирі метрики на дані, готові для панелі керування. Запустіть один раз:

```bash
php vendor/bin/runway apm:worker
```

**Що він робить?**
- Читає з вашого джерела (наприклад, `apm_metrics.sqlite`).
- Обробляє до 100 метрик (розмір партії за замовчуванням) у ваше призначення.
- Зупиняється, коли завершено або якщо метрик не лишилося.

**Тримайте його запущеним**
Для живих додатків ви захочете безперервну обробку. Ось ваші варіанти:

- **Режим Daemon**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Працює вічно, обробляючи метрики по мірі надходження. Чудово для розробки чи малих налаштувань.

- **Crontab**:
  Додайте це до вашого crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускається щохвилини — ідеально для продакшну.

- **Tmux/Screen**:
  Почніть відокремлену сесію:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, then D to detach; `tmux attach -t apm-worker` to reconnect
  ```
  Тримає запущеним навіть якщо ви вийшли з логіну.

- **Кастомні налаштування**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обробляє 50 метрик за раз.
  - `--max_messages 1000`: Зупиняється після 1000 метрик.
  - `--timeout 300`: Виходить після 5 хвилин.

**Чому турбуватися?**
Без робочого процесу ваша панель керування порожня. Це міст між сирими логами та корисними інсайтами.

### 4. Запустіть панель керування

Побачите життєві показники вашого додатку:

```bash
php vendor/bin/runway apm:dashboard
```

**Що це?**
- Запускає PHP-сервер на `http://localhost:8001/apm/dashboard`.
- Показує логи запитів, повільні маршрути, рівень помилок і більше.

**Налаштуйте це**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступний з будь-якого IP (корисно для віддаленого перегляду).
- `--port 8080`: Використовуйте інший порт, якщо 8001 зайнятий.
- `--php-path`: Вкажіть на PHP, якщо його немає в PATH.

Відкрийте URL у браузері та досліджуйте!

#### Режим продакшну

Для продакшну вам може знадобитися спробувати кілька технік, щоб запустити панель керування, оскільки, ймовірно, є фаєрволи та інші заходи безпеки. Ось кілька варіантів:

- **Використовуйте зворотний проксі**: Налаштуйте Nginx чи Apache для перенаправлення запитів до панелі керування.
- **SSH-тунель**: Якщо ви можете SSH на сервер, використовуйте `ssh -L 8080:localhost:8001 youruser@yourserver`, щоб тунелювати панель керування на вашу локальну машину.
- **VPN**: Якщо ваш сервер за VPN, підключіться до нього та отримайте доступ до панелі керування безпосередньо.
- **Налаштуйте фаєрвол**: Відкрийте порт 8001 для вашого IP чи мережі сервера. (або який порт ви встановили).
- **Налаштуйте Apache/Nginx**: Якщо у вас є веб-сервер перед додатком, ви можете налаштувати його на домен чи піддомен. Якщо ви це робите, ви встановите корінь документів на `/path/to/your/project/vendor/flightphp/apm/dashboard`

#### Хочете іншу панель керування?

Ви можете побудувати свою власну панель керування, якщо хочете! Подивіться на директорію vendor/flightphp/apm/src/apm/presenter для ідей, як представити дані для вашої власної панелі керування!

## Функції панелі керування

Панель керування — ваш штаб APM: ось що ви побачите:

- **Лог запитів**: Кожен запит з міткою часу, URL, кодом відповіді та загальним часом. Клікніть «Деталі» для middleware, запитів та помилок.
- **Найповільніші запити**: Топ 5 запитів, що займають час (наприклад, «/api/heavy» за 2.5с).
- **Найповільніші маршрути**: Топ 5 маршрутів за середнім часом — чудово для виявлення патернів.
- **Рівень помилок**: Відсоток невдалих запитів (наприклад, 2.3% 500s).
- **Перцентилі затримок**: 95-й (p95) та 99-й (p99) часи відповідей — знайте ваші найгірші сценарії.
- **Графік кодів відповідей**: Візуалізуйте 200s, 404s, 500s з часом.
- **Довгі запити/Middleware**: Топ 5 повільних викликів бази даних та шарів middleware.
- **Попадання/промах кешу**: Як часто ваш кеш рятує ситуацію.

**Додатково**:
- Фільтруйте за «Останню годину», «Останній день» чи «Останній тиждень».
- Перемикайте темний режим для пізніх сесій.

**Приклад**:
Запит до `/users` може показати:
- Загальний час: 150ms
- Middleware: `AuthMiddleware->handle` (50ms)
- Запит: `SELECT * FROM users` (80ms)
- Кеш: Попадання на `user_list` (5ms)

## Додавання кастомних подій

Відстежуйте будь-що — як виклик API чи процес платежу:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Де це з'являється?**
У деталях запиту панелі керування під «Кастомні події» — розширюється з гарним форматуванням JSON.

**Випадок використання**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Тепер ви побачите, чи той API тягне ваш додаток вниз!

## Моніторинг бази даних

Відстежуйте PDO-запити ось так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite', null, null, null, true); // <-- True обов'язково для увімкнення відстеження в APM.
$Apm->addPdoConnection($pdo);
```

**Що ви отримуєте**:
- Текст запиту (наприклад, `SELECT * FROM users WHERE id = ?`)
- Час виконання (наприклад, 0.015s)
- Кількість рядків (наприклад, 42)

**Увага**:
- **Опціонально**: Пропустіть це, якщо не потрібно відстеження БД.
- **Тільки PdoWrapper**: Основний PDO ще не підключений — чекайте!
- **Попередження про продуктивність**: Логування кожного запиту на БД-важкому сайті може сповільнити. Використовуйте вибірку (`$Apm = new Apm($ApmLogger, 0.1)`), щоб полегшити навантаження.

**Приклад виводу**:
- Запит: `SELECT name FROM products WHERE price > 100`
- Час: 0.023s
- Рядки: 15

## Опції Worker

Налаштуйте робочий процес на свій смак:

- `--timeout 300`: Зупиняється після 5 хвилин — добре для тестування.
- `--max_messages 500`: Обмежує 500 метриками — тримає скінченним.
- `--batch_size 200`: Обробляє 200 за раз — балансує швидкість і пам'ять.
- `--daemon`: Працює без зупинки — ідеально для живого моніторингу.

**Приклад**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Працює годину, обробляючи 100 метрик за раз.

## Request ID у додатку

Кожен запит має унікальний ID запиту для відстеження. Ви можете використовувати цей ID у своєму додатку для кореляції логів і метрик. Наприклад, ви можете додати ID запиту на сторінку помилки:

```php
Flight::map('error', function($message) {
	// Отримайте ID запиту з заголовка відповіді X-Flight-Request-Id
	$requestId = Flight::response()->getHeader('X-Flight-Request-Id');

	// Додатково ви можете отримати його з змінної Flight
	// Цей метод не працюватиме добре в swoole чи інших асинхронних платформах.
	// $requestId = Flight::get('apm.request_id');
	
	echo "Error: $message (Request ID: $requestId)";
});
```

## Оновлення

Якщо ви оновлюєтеся до новішої версії APM, є шанс, що потрібно запустити міграції бази даних. Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:migrate
```
Це запустить будь-які необхідні міграції для оновлення схеми бази даних до останньої версії.

**Примітка:** Якщо ваша база даних APM велика за розміром, ці міграції можуть зайняти деякий час. Ви можете запустити цю команду під час непікових годин.

## Очищення старих даних

Щоб тримати вашу базу даних охайною, ви можете очистити старі дані. Це особливо корисно, якщо ви ведете зайнятий додаток і хочете тримати розмір бази даних керованою.
Ви можете зробити це, запустивши таку команду:

```bash
php vendor/bin/runway apm:purge
```
Це видалить усі дані старші за 30 днів з бази даних. Ви можете скоригувати кількість днів, передавши інше значення опції `--days`:

```bash
php vendor/bin/runway apm:purge --days 7
```
Це видалить усі дані старші за 7 днів з бази даних.

## Вирішення проблем

Застрягли? Спробуйте ці:

- **Немає даних у панелі керування?**
  - Чи запущений робочий процес? Перевірте `ps aux | grep apm:worker`.
  - Шляхи конфігурації збігаються? Перевірте, чи DSN у `.runway-config.json` вказують на реальні файли.
  - Запустіть `php vendor/bin/runway apm:worker` вручну для обробки очікуваних метрик.

- **Помилки робочого процесу?**
  - Подивіться на ваші SQLite-файли (наприклад, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Перевірте логи PHP на стек-трейси.

- **Панель керування не запускається?**
  - Порт 8001 зайнятий? Використовуйте `--port 8080`.
  - PHP не знайдено? Використовуйте `--php-path /usr/bin/php`.
  - Фаєрвол блокує? Відкрийте порт або використовуйте `--host localhost`.

- **Занадто повільно?**
  - Зменште рівень вибірки: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Зменште розмір партії: `--batch_size 20`.

- **Не відстежує винятки/помилки?**
  - Якщо у вас увімкнено [Tracy](https://tracy.nette.org/) для проєкту, це перекриє обробку помилок Flight. Вам потрібно вимкнути Tracy і переконатися, що `Flight::set('flight.handle_errors', true);` встановлено.

- **Не відстежує запити до бази даних?**
  - Переконайтеся, що ви використовуєте `PdoWrapper` для з'єднань з базою даних.
  - Переконайтеся, що останній аргумент у конструкторі — `true`.