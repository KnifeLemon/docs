# Документация по FlightPHP APM

Добро пожаловать в FlightPHP APM — ваш личный тренер производительности приложения! Это руководство — ваша карта пути для настройки, использования и освоения мониторинга производительности приложений (APM) с FlightPHP. Независимо от того, охотитесь ли вы за медленными запросами или просто хотите углубиться в графики задержек, мы всё охватили. Давайте сделаем ваше приложение быстрее, пользователей счастливее, а сессии отладки — проще!

## Почему APM важно

Представьте: ваше приложение — это оживленный ресторан. Без возможности отслеживать, сколько времени занимает обработка заказов или где кухня застопорилась, вы просто угадываете, почему клиенты уходят раздраженными. APM — ваш помощник-шеф-повар — он наблюдает за каждым шагом, от входящих запросов до запросов к базе данных, и отмечает всё, что замедляет процесс. Медленные страницы отпугивают пользователей (исследования показывают, что 53% уходят, если сайт загружается более 3 секунд!), и APM помогает выявить эти проблемы *до* того, как они нанесут ущерб. Это проактивный покой души — меньше моментов "почему это сломано?", больше побед "смотрите, как это работает гладко!".

## Установка

Начните с Composer:

```bash
composer require flightphp/apm
```

Вам понадобится:
- **PHP 7.4+**: Обеспечивает совместимость с LTS-версиями Linux, при этом поддерживая современный PHP.
- **[FlightPHP Core](https://github.com/flightphp/core) v3.15+**: Легковесный фреймворк, который мы улучшаем.

## Начало работы

Вот ваш пошаговый гид к крутизне APM:

### 1. Зарегистрируйте APM

Добавьте это в ваш файл `index.php` или `services.php`, чтобы начать отслеживание:

```php
use flight\apm\logger\LoggerFactory;
use flight\Apm;

$ApmLogger = LoggerFactory::create(__DIR__ . '/../../.runway-config.json');
$Apm = new Apm($ApmLogger);
$Apm->bindEventsToFlightInstance($app);
```

**Что здесь происходит?**
- `LoggerFactory::create()` берёт вашу конфигурацию (об этом позже) и настраивает логгер — по умолчанию SQLite.
- `Apm` — звезда: он слушает события Flight (запросы, маршруты, ошибки и т.д.) и собирает метрики.
- `bindEventsToFlightInstance($app)` связывает всё с вашим приложением Flight.

**Профессиональный совет: Сэмплирование**
Если ваше приложение загружено, логирование *каждого* запроса может перегружать систему. Используйте коэффициент сэмплирования (от 0.0 до 1.0):

```php
$Apm = new Apm($ApmLogger, 0.1); // Логирует 10% запросов
```

Это сохраняет производительность быстрой, при этом давая надёжные данные.

### 2. Настройте его

Запустите это, чтобы создать ваш `.runway-config.json`:

```bash
php vendor/bin/runway apm:init
```

**Что это делает?**
- Запускает мастер, спрашивающий, откуда берутся сырые метрики (источник) и куда уходят обработанные данные (назначение).
- По умолчанию — SQLite, например, `sqlite:/tmp/apm_metrics.sqlite` для источника, другой для назначения.
- В результате вы получите конфигурацию вроде:
  ```json
  {
    "apm": {
      "source_type": "sqlite",
      "source_db_dsn": "sqlite:/tmp/apm_metrics.sqlite",
      "storage_type": "sqlite",
      "dest_db_dsn": "sqlite:/tmp/apm_metrics_processed.sqlite"
    }
  }
  ```

> Этот процесс также спросит, хотите ли вы запустить миграции для этой настройки. Если вы устанавливаете это впервые, ответ — да.

**Почему два места?**
Сырые метрики накапливаются быстро (представьте нефильтрованные логи). Работник обрабатывает их в структурированное назначение для дашборда. Это поддерживает порядок!

### 3. Обработайте метрики с помощью работника

Работник превращает сырые метрики в данные, готовые для дашборда. Запустите его один раз:

```bash
php vendor/bin/runway apm:worker
```

**Что он делает?**
- Читает из вашего источника (например, `apm_metrics.sqlite`).
- Обрабатывает до 100 метрик (размер пакета по умолчанию) в назначение.
- Останавливается, когда закончено или если метрик не осталось.

**Поддерживайте его запущенным**
Для живых приложений вам нужна непрерывная обработка. Вот ваши варианты:

- **Режим демона**:
  ```bash
  php vendor/bin/runway apm:worker --daemon
  ```
  Работает вечно, обрабатывая метрики по ходу. Отлично для разработки или небольших настроек.

- **Crontab**:
  Добавьте это в ваш crontab (`crontab -e`):
  ```bash
  * * * * * php /path/to/project/vendor/bin/runway apm:worker
  ```
  Запускается каждую минуту — идеально для продакшена.

- **Tmux/Screen**:
  Запустите сеанс, который можно отсоединить:
  ```bash
  tmux new -s apm-worker
  php vendor/bin/runway apm:worker --daemon
  # Ctrl+B, затем D для отсоединения; `tmux attach -t apm-worker` для подключения
  ```
  Поддерживает работу даже если вы вышли из системы.

- **Пользовательские настройки**:
  ```bash
  php vendor/bin/runway apm:worker --batch_size 50 --max_messages 1000 --timeout 300
  ```
  - `--batch_size 50`: Обрабатывает 50 метрик за раз.
  - `--max_messages 1000`: Останавливается после 1000 метрик.
  - `--timeout 300`: Завершается через 5 минут.

**Зачем это нужно?**
Без работника ваш дашборд пуст. Это мост между сырыми логами и полезными инсайтами.

### 4. Запустите дашборд

Посмотрите на витальные признаки вашего приложения:

```bash
php vendor/bin/runway apm:dashboard
```

**Что это?**
- Запускает сервер PHP на `http://localhost:8001/apm/dashboard`.
- Показывает логи запросов, медленные маршруты, уровень ошибок и многое другое.

**Настройте его**:
```bash
php vendor/bin/runway apm:dashboard --host 0.0.0.0 --port 8080 --php-path=/usr/local/bin/php
```
- `--host 0.0.0.0`: Доступно с любого IP (удобно для удаленного просмотра).
- `--port 8080`: Используйте другой порт, если 8001 занят.
- `--php-path`: Укажите путь к PHP, если он не в PATH.

Откройте URL в браузере и исследуйте!

#### Режим продакшена

В продакшене вам может потребоваться попробовать несколько техник, чтобы запустить дашборд, так как там, вероятно, есть фаерволы и другие меры безопасности. Вот несколько вариантов:

- **Используйте обратный прокси**: Настройте Nginx или Apache для переадресации запросов на дашборд.
- **SSH-туннель**: Если вы можете SSH в сервер, используйте `ssh -L 8080:localhost:8001 youruser@yourserver`, чтобы туннелировать дашборд на вашу локальную машину.
- **VPN**: Если сервер за VPN, подключитесь к нему и доступьтесь к дашборду напрямую.
- **Настройте фаервол**: Откройте порт 8001 для вашего IP или сети сервера (или любого другого порта, который вы установили).
- **Настройте Apache/Nginx**: Если у вас есть веб-сервер перед приложением, настройте его на домен или поддомен. В этом случае установите корень документов в `/path/to/your/project/vendor/flightphp/apm/dashboard`.

#### Хотите другой дашборд?

Вы можете создать свой собственный дашборд, если хотите! Посмотрите в директорию `vendor/flightphp/apm/src/apm/presenter` за идеями, как представить данные для вашего дашборда!

## Возможности дашборда

Дашборд — ваш штаб APM — вот что вы увидите:

- **Лог запросов**: Каждый запрос с отметкой времени, URL, кодом ответа и общим временем. Нажмите "Детали" для просмотра посредников, запросов и ошибок.
- **Самые медленные запросы**: Топ-5 запросов, которые занимают много времени (например, "/api/heavy" за 2.5 с).
- **Самые медленные маршруты**: Топ-5 маршрутов по среднему времени — отлично для выявления шаблонов.
- **Уровень ошибок**: Процент неудачных запросов (например, 2.3% кодов 500).
- **Процентили задержек**: 95-й (p95) и 99-й (p99) времена ответов — знайте ваши худшие сценарии.
- **График кодов ответов**: Визуализируйте 200-е, 404-е, 500-е со временем.
- **Длинные запросы/Посредники**: Топ-5 медленных вызовов базы данных и слоёв посредников.
- **Попадания/Промахи кэша**: Насколько часто кэш спасает ситуацию.

**Дополнительно**:
- Фильтруйте по "Последний час", "Последний день" или "Последняя неделя".
- Переключайте тёмный режим для ночных сессий.

**Пример**:
Запрос к `/users` может показать:
- Общее время: 150 мс
- Посредник: `AuthMiddleware->handle` (50 мс)
- Запрос: `SELECT * FROM users` (80 мс)
- Кэш: Попадание по `user_list` (5 мс)

## Добавление пользовательских событий

Отслеживайте что угодно — например, вызов API или процесс оплаты:

```php
use flight\apm\CustomEvent;

$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('api_call', [
    'endpoint' => 'https://api.example.com/users',
    'response_time' => 0.25,
    'status' => 200
]));
```

**Где это отобразится?**
В деталях запроса дашборда под "Пользовательскими событиями" — расширяемо с красивым форматом JSON.

**Пример использования**:
```php
$start = microtime(true);
$apiResponse = file_get_contents('https://api.example.com/data');
$app->eventDispatcher()->trigger('apm.custom', new CustomEvent('external_api', [
    'url' => 'https://api.example.com/data',
    'time' => microtime(true) - $start,
    'success' => $apiResponse !== false
]));
```
Теперь вы увидите, если этот API замедляет ваше приложение!

## Мониторинг базы данных

Отслеживайте запросы PDO вот так:

```php
use flight\database\PdoWrapper;

$pdo = new PdoWrapper('sqlite:/path/to/db.sqlite');
$Apm->addPdoConnection($pdo);
```

**Что вы получаете**:
- Текст запроса (например, `SELECT * FROM users WHERE id = ?`)
- Время выполнения (например, 0.015 с)
- Количество строк (например, 42)

**Внимание**:
- **Опционально**: Пропустите, если вам не нужен трекинг БД.
- **Только PdoWrapper**: Обычный PDO пока не подключен — следите за обновлениями!
- **Предупреждение о производительности**: Логирование каждого запроса на сайте с тяжёлой БД может замедлить всё. Используйте сэмплирование (`$Apm = new Apm($ApmLogger, 0.1)`), чтобы облегчить нагрузку.

**Пример вывода**:
- Запрос: `SELECT name FROM products WHERE price > 100`
- Время: 0.023 с
- Строки: 15

## Опции работника

Настройте работника по вашему вкусу:

- `--timeout 300`: Останавливается через 5 минут — хорошо для тестов.
- `--max_messages 500`: Ограничивает 500 метриками — делает это конечным.
- `--batch_size 200`: Обрабатывает 200 за раз — балансирует скорость и память.
- `--daemon`: Работает nonstop — идеально для живого мониторинга.

**Пример**:
```bash
php vendor/bin/runway apm:worker --daemon --batch_size 100 --timeout 3600
```
Работает час, обрабатывая 100 метрик за раз.

## ID запроса в приложении

Каждый запрос имеет уникальный ID для отслеживания. Вы можете использовать этот ID в приложении, чтобы коррелировать логи и метрики. Например, добавьте ID запроса на страницу ошибок:

```php
Flight::map('error', function($message) {
	// Получите ID запроса из заголовка ответа X-Flight-Request-Id
	$requestId = Flight::response()->getHeader('X-Flight-Request-Id');

	// Кроме того, вы можете получить его из переменной Flight
	// Этот метод может не сработать в Swoole или других асинхронных платформах.
	// $requestId = Flight::get('apm.request_id');
	
	echo "Error: $message (Request ID: $requestId)";
});
```

## Обновление

Если вы обновляетесь до новой версии APM, возможно, потребуется запустить миграции базы данных. Сделайте это командой:

```bash
php vendor/bin/runway apm:migrate
```
Это запустит все необходимые миграции для обновления схемы базы данных до последней версии.

**Примечание:** Если база данных APM велика, эти миграции могут занять время. Запустите команду в часы с низкой нагрузкой.

## Очистка старых данных

Чтобы поддерживать базу данных в порядке, вы можете очистить старые данные. Это особенно полезно для загруженных приложений, чтобы сохранить размер базы управляемым.
Сделайте это командой:

```bash
php vendor/bin/runway apm:purge
```
Это удалит все данные старше 30 дней из базы данных. Вы можете изменить количество дней, передавая другое значение опции `--days`:

```bash
php vendor/bin/runway apm:purge --days 7
```
Это удалит все данные старше 7 дней из базы данных.

## Устранение неисправностей

Зависли? Попробуйте эти советы:

- **Нет данных в дашборде?**
  - Работает ли работник? Проверьте `ps aux | grep apm:worker`.
  - Совпадают ли пути в конфигурации? Проверьте DSN в `.runway-config.json`, чтобы они указывали на реальные файлы.
  - Запустите `php vendor/bin/runway apm:worker` вручную, чтобы обработать ожидающие метрики.

- **Ошибки работника?**
  - Посмотрите в файлы SQLite (например, `sqlite3 /tmp/apm_metrics.sqlite "SELECT * FROM apm_metrics_log LIMIT 5"`).
  - Проверьте логи PHP на наличие стек-трейсов.

- **Дашборд не запускается?**
  - Занят ли порт 8001? Используйте `--port 8080`.
  - PHP не найден? Используйте `--php-path /usr/bin/php`.
  - Фаервол блокирует? Откройте порт или используйте `--host localhost`.

- **Слишком медленно?**
  - Уменьшите коэффициент сэмплирования: `$Apm = new Apm($ApmLogger, 0.05)` (5%).
  - Уменьшите размер пакета: `--batch_size 20`.