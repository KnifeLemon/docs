## Промежуточное программное обеспечение маршрута

`Flight` поддерживает промежуточное программное обеспечение маршрута и группы маршрутов. Промежуточное программное обеспечение представляет собой функцию, которая выполняется до (или после) обратного вызова маршрута. Это отличный способ добавить проверки аутентификации API в ваш код или проверить, имеет ли пользователь разрешение на доступ к маршруту.

## Основное промежуточное программное обеспечение

Вот базовый пример:

```php
// Если вы предоставляете только анонимную функцию, она будет выполнена до вызова маршрута. 
// кроме классов, нет функций промежуточного программного обеспечения "после" (см. ниже) 
Flight::route('/path', function() { echo 'Здесь я!'; })->addMiddleware(function() {
	echo 'Промежуточное программное обеспечение вначале!';
});

Flight::start();

// Это выведет "Промежуточное программное обеспечение вначале! Здесь я!"
```

Существуют некоторые очень важные замечания о промежуточном программном обеспечении, о которых вам следует знать перед их использованием:
- Функции промежуточного программного обеспечения выполняются в порядке добавления к маршруту. Выполнение аналогично тому, как это делает [Slim Framework](https://www.slimframework.com/docs/v4/concepts/middleware.html#how-does-middleware-work).
   - Префиксы выполняются в добавленном порядке, а постфиксы выполняются в обратном порядке.
- Если ваша функция промежуточного программного обеспечения возвращает false, все выполнение останавливается, и выбрасывается ошибка 403 Forbidden. Вам, вероятно, захочется обработать это более гибко с помощью `Flight::redirect()` или чего-то подобного.
- Если вам нужны параметры из вашего маршрута, они будут передаваться в виде единственного массива в вашу функцию промежуточного программного обеспечения. (`function($params) { ... }` или `public function before($params) {}`). Причина в том, что вы можете организовать свои параметры в группы, и в некоторых из этих групп ваши параметры могут на самом деле появляться в другом порядке, что сломало бы функцию промежуточного программного обеспечения, обращаясь к неправильному параметру. Таким образом, вы можете обращаться к ним по имени, а не по позиции.
- Если вы передадите только имя промежуточного программного обеспечения, оно будет автоматически выполнено контейнером внедрения зависимостей и промежуточное программное обеспечение будет выполняться с необходимыми параметрами. Если у вас нет зарегистрированного контейнера внедрения зависимостей, будет передан экземпляр `flight\Engine` в `__construct()`.

## Классы промежуточного программного обеспечения

Промежуточное программное обеспечение можно также зарегистрировать как класс. Если вам нужна функциональность "после", вы **должны** использовать класс.

```php
class МоеПромежуточное {
	public function before($params) {
		echo 'Промежуточное программное обеспечение вначале!';
	}

	public function after($params) {
		echo 'Промежуточное программное обеспечение вконце!';
	}
}

$MyMiddleware = new МоеПромежуточное();
Flight::route('/path', function() { echo 'Здесь я! '; })->addMiddleware($MyMiddleware); // также ->addMiddleware([ $MyMiddleware, $MyMiddleware2 ]);

Flight::start();

// Это отобразит "Промежуточное программное обеспечение вначале! Здесь я! Промежуточное программное обеспечение вконце!"
```

## Обработка ошибок промежуточного программного обеспечения

Допустим, у вас есть аутентификационное промежуточное программное обеспечение, и вы хотите перенаправить пользователя на страницу входа, если он не аутентифицирован. У вас есть несколько вариантов:

1. Вы можете вернуть false из функции промежуточного программного обеспечения, и `Flight` автоматически вернет ошибку 403 Forbidden, но без настройки.
1. Вы можете перенаправить пользователя на страницу входа, используя `Flight::redirect()`.
1. Вы можете создать специальную ошибку внутри промежуточного программного обеспечения и прекратить выполнение маршрута.

### Базовый пример

Вот простой пример с `return false;`:
```php
class MyMiddleware {
	public function before($params) {
		if (isset($_SESSION['user']) === false) {
			return false;
		}

		// поскольку это true, все продолжается
	}
}
```

### Пример перенаправления

Вот пример перенаправления пользователя на страницу входа:
```php
class MyMiddleware {
	public function before($params) {
		if (isset($_SESSION['user']) === false) {
			Flight::redirect('/login');
			exit;
		}
	}
}
```

### Пример пользовательской ошибки

Предположим, вам нужно сгенерировать ошибку JSON, потому что вы создаете API. Вы можете сделать это следующим образом:
```php
class MyMiddleware {
	public function before($params) {
		$authorization = Flight::request()->headers['Authorization'];
		if(empty($authorization)) {
			Flight::json(['error' => 'Для доступа к этой странице необходимо войти в систему.'], 403);
			exit;
			// или
			Flight::halt(403, json_encode(['error' => 'Для доступа к этой странице необходимо войти в систему.']);
		}
	}
}
```

## Группировка промежуточного программного обеспечения

Вы можете добавить группу маршрутов, и затем каждый маршрут в этой группе также будет иметь то же самое промежуточное программное обеспечение. Это полезно, если вам нужно сгруппировать множество маршрутов, например, с помощью промежуточного программного обеспечения `Auth` для проверки API-ключа в заголовке.

```php

// добавлено в конец метода группы
Flight::group('/api', function() {

	// Этот "пустой" маршрут на самом деле будет соответствовать /api
	Flight::route('', function() { echo 'api'; }, false, 'api');
    Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'user:'.$id; }, false, 'user_view');
}, [ new ApiAuthMiddleware() ]);
```

Если вы хотите применить глобальное промежуточное программное обеспечение ко всем своим маршрутам, вы можете добавить "пустую" группу:

```php

// добавлено в конец метода группы
Flight::group('', function() {
	Flight::route('/users', function() { echo 'users'; }, false, 'users');
	Flight::route('/users/@id', function($id) { echo 'user:'.$id; }, false, 'user_view');
}, [ new ApiAuthMiddleware() ]);
```